<!DOCTYPE html>
<html>
<head>
  <title>MedLab 3D — Type 1 Diabetes</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Rajdhani:wght@400;600;700&family=Share+Tech+Mono&display=swap');
    *{margin:0;padding:0;box-sizing:border-box;}
    body{overflow:hidden;font-family:'Rajdhani',sans-serif;background:#050a12;}
    #menu,#labOptions{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);text-align:center;color:white;z-index:10;}
    #menu h1{font-size:52px;font-weight:700;letter-spacing:6px;text-transform:uppercase;background:linear-gradient(135deg,#00e5ff,#7c4dff,#00e5ff);background-size:200%;-webkit-background-clip:text;-webkit-text-fill-color:transparent;animation:shimmer 3s linear infinite;margin-bottom:8px;}
    #menu p{font-family:'Share Tech Mono',monospace;color:#00e5ff88;font-size:13px;letter-spacing:4px;margin-bottom:6px;}
    #menu .sub{font-family:'Share Tech Mono',monospace;color:#ff884488;font-size:11px;letter-spacing:3px;margin-bottom:40px;}
    @keyframes shimmer{0%,100%{background-position:0%}50%{background-position:200%}}
    .btn{font-family:'Rajdhani',sans-serif;font-size:18px;font-weight:600;letter-spacing:3px;padding:14px 36px;margin:8px;border:none;border-radius:4px;cursor:pointer;transition:all 0.25s;text-transform:uppercase;position:relative;overflow:hidden;}
    .btn-primary{background:linear-gradient(135deg,#00b8d4,#6200ea);color:white;box-shadow:0 0 30px #00e5ff44,0 4px 20px #00000088;}
    .btn-primary::before{content:'';position:absolute;inset:0;background:linear-gradient(135deg,#00e5ff,#7c4dff);opacity:0;transition:opacity 0.25s;}
    .btn-primary:hover::before{opacity:1;}
    .btn-primary:hover{transform:translateY(-2px);box-shadow:0 0 50px #00e5ff66,0 8px 30px #00000099;}
    .btn-primary span{position:relative;z-index:1;}
    .btn-secondary{background:transparent;color:#00e5ff;border:1px solid #00e5ff55;box-shadow:0 0 20px #00e5ff22 inset;}
    .btn-secondary:hover{background:#00e5ff15;border-color:#00e5ff;transform:translateY(-2px);}
    #labOptions h2{font-size:28px;letter-spacing:5px;text-transform:uppercase;color:#00e5ff;margin-bottom:30px;font-weight:600;}
    #hud{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);display:none;font-family:'Share Tech Mono',monospace;color:#00e5ffbb;font-size:12px;letter-spacing:2px;background:#00000088;backdrop-filter:blur(10px);padding:10px 24px;border-radius:40px;border:1px solid #00e5ff22;z-index:10;text-align:center;}
    #hud span{margin:0 10px;}
    #hud .key{background:#00e5ff22;border:1px solid #00e5ff44;padding:2px 7px;border-radius:3px;font-size:11px;}
    #modeIndicator{position:absolute;top:20px;right:24px;font-family:'Share Tech Mono',monospace;color:#00e5ff99;font-size:11px;letter-spacing:3px;background:#00000066;backdrop-filter:blur(10px);padding:8px 16px;border-radius:4px;border:1px solid #00e5ff22;display:none;z-index:10;}
    #entryOverlay{position:absolute;inset:0;background:radial-gradient(ellipse at center,#050a1200 40%,#050a12 100%);pointer-events:none;z-index:5;}
    canvas{display:block;position:absolute;inset:0;}

    #drugPanel{display:none;position:absolute;top:50%;left:24px;transform:translateY(-50%);width:320px;background:#020810f2;backdrop-filter:blur(18px);border:1px solid #00e5ff44;border-radius:10px;z-index:20;font-family:'Share Tech Mono',monospace;box-shadow:0 0 40px #00e5ff22,0 20px 60px #000000bb;overflow:hidden;}
    #dph{padding:14px 18px 12px;border-bottom:1px solid #00e5ff22;background:linear-gradient(135deg,#001a2a,#0a0520);display:flex;justify-content:space-between;align-items:flex-start;}
    #dptitle{color:#00e5ff;font-size:14px;letter-spacing:3px;font-weight:bold;}
    #dpclass{color:#00e5ff66;font-size:9px;letter-spacing:2px;margin-top:3px;}
    #closeDrug{background:none;border:none;color:#00e5ff44;font-size:16px;cursor:pointer;transition:color 0.2s;line-height:1;}
    #closeDrug:hover{color:#00e5ff;}
    #dpbody{padding:14px 18px;}
    .ds{color:#00e5ff66;font-size:9px;letter-spacing:3px;margin:10px 0 5px;}
    .ds:first-child{margin-top:0;}
    .dd{color:#c0e0ff;font-size:11px;line-height:1.65;}
    .dtag{display:inline-block;background:#00e5ff15;border:1px solid #00e5ff33;color:#00e5ffcc;font-size:9px;letter-spacing:1px;padding:2px 7px;border-radius:3px;margin:2px 2px 2px 0;}
    .dtag.w{background:#ff6b6b15;border-color:#ff6b6b44;color:#ffaaaa;}
    #dpmech{padding:10px 18px 14px;border-top:1px solid #00e5ff11;color:#9988cc;font-size:10px;line-height:1.6;font-style:italic;}
    #dpActions{padding:0 18px 14px;display:flex;gap:8px;}
    #dpActions button{flex:1;font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;padding:8px 6px;border-radius:4px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;}
    #adminBtn{background:linear-gradient(135deg,#00b8d4,#006688);color:white;border:1px solid #00e5ff66;box-shadow:0 0 12px #00e5ff33;}
    #adminBtn:hover{box-shadow:0 0 20px #00e5ff66;transform:translateY(-1px);}
    #adminBtn.administered{background:linear-gradient(135deg,#005500,#228833);border-color:#44ff8866;box-shadow:0 0 12px #44ff8833;pointer-events:none;}

    /* Regimen panel */
    #regimenPanel{display:none;position:absolute;top:20px;left:24px;width:280px;background:#020810ee;backdrop-filter:blur(18px);border:1px solid #00e5ff33;border-radius:10px;z-index:20;font-family:'Share Tech Mono',monospace;box-shadow:0 0 30px #00000088;overflow:hidden;}
    #regimenPanel .rp-head{padding:12px 16px 10px;border-bottom:1px solid #00e5ff22;background:linear-gradient(135deg,#0a1a2a,#100820);}
    #regimenPanel .rp-title{color:#00e5ff;font-size:12px;letter-spacing:3px;font-weight:bold;}
    #regimenPanel .rp-sub{color:#00e5ff55;font-size:9px;letter-spacing:2px;margin-top:2px;}
    #regimenPanel .rp-body{padding:10px 16px 14px;max-height:200px;overflow-y:auto;}
    .regimen-item{padding:6px 0;border-bottom:1px solid #ffffff08;display:flex;justify-content:space-between;align-items:center;}
    .regimen-item .ri-name{color:#c0e0ff;font-size:10px;letter-spacing:1px;}
    .regimen-item .ri-dose{color:#00e5ff88;font-size:9px;}
    .regimen-item .ri-remove{background:none;border:1px solid #ff6b6b33;color:#ff6b6b88;font-size:9px;padding:2px 6px;border-radius:3px;cursor:pointer;transition:all 0.2s;}
    .regimen-item .ri-remove:hover{border-color:#ff6b6b;color:#ff6b6b;}
    .rp-empty{color:#ffffff33;font-size:10px;text-align:center;padding:12px 0;}
    #regimenFeedback{padding:8px 16px 12px;border-top:1px solid #00e5ff11;font-size:10px;line-height:1.5;color:#88aacc;max-height:250px;overflow-y:auto;}
    #checkRegimenBtn{margin:0 16px 12px;padding:8px;width:calc(100% - 32px);font-family:'Share Tech Mono',monospace;font-size:10px;letter-spacing:2px;background:linear-gradient(135deg,#6200ea,#9c27b0);color:white;border:1px solid #bb86fc55;border-radius:4px;cursor:pointer;transition:all 0.2s;text-transform:uppercase;}
    #checkRegimenBtn:hover{box-shadow:0 0 16px #bb86fc44;transform:translateY(-1px);}

    /* Toast */
    #toast{position:absolute;top:80px;left:50%;transform:translateX(-50%);background:#020810ee;border:1px solid #44ff8844;color:#88ffaa;font-family:'Share Tech Mono',monospace;font-size:12px;letter-spacing:2px;padding:10px 28px;border-radius:6px;z-index:30;display:none;box-shadow:0 0 20px #44ff8833;animation:toastIn .3s ease;}
    #toast.error{border-color:#ff6b6b44;color:#ffaaaa;box-shadow:0 0 20px #ff6b6b33;}
    #toast.warning{border-color:#ffaa4444;color:#ffcc88;box-shadow:0 0 20px #ffaa4433;}

    /* Patient chart panel */
    #patientPanel{display:none;position:absolute;top:50%;right:24px;transform:translateY(-50%);width:380px;max-height:85vh;background:#0a0410f4;backdrop-filter:blur(18px);border:1px solid #ff884466;border-radius:10px;z-index:20;font-family:'Share Tech Mono',monospace;box-shadow:0 0 40px #ff884422,0 20px 60px #000000bb;overflow:hidden;}
    #pph{padding:14px 18px 12px;border-bottom:1px solid #ff884422;background:linear-gradient(135deg,#1a0a00,#200810);display:flex;justify-content:space-between;align-items:flex-start;}
    #pptitle{color:#ff8844;font-size:14px;letter-spacing:3px;font-weight:bold;}
    #ppsubtitle{color:#ff884466;font-size:9px;letter-spacing:2px;margin-top:3px;}
    #closePatient{background:none;border:none;color:#ff884444;font-size:16px;cursor:pointer;transition:color 0.2s;line-height:1;}
    #closePatient:hover{color:#ff8844;}
    #ppbody{padding:14px 18px;overflow-y:auto;max-height:calc(85vh - 60px);}
    #ppbody .ds{color:#ff884466;font-size:9px;letter-spacing:3px;margin:12px 0 5px;}
    #ppbody .ds:first-child{margin-top:0;}
    #ppbody .dd{color:#ddc8b0;font-size:11px;line-height:1.65;}
    .lab-val{display:inline-block;margin:2px 2px 2px 0;padding:3px 8px;border-radius:3px;font-size:10px;letter-spacing:1px;}
    .lab-val.crit{background:#ff444418;border:1px solid #ff444444;color:#ffaaaa;}
    .lab-val.low{background:#4488ff18;border:1px solid #4488ff44;color:#aaccff;}
    .lab-val.pos{background:#ff884418;border:1px solid #ff884444;color:#ffcc88;}
    @keyframes toastIn{from{opacity:0;transform:translateX(-50%) translateY(-10px);}to{opacity:1;transform:translateX(-50%) translateY(0);}}
  </style>
</head>
<body>
<div id="entryOverlay"></div>
<canvas id="labCanvas"></canvas>

<div id="menu">
  <h1>MedLab 3D</h1>
  <p>VIRTUAL SIMULATION ENVIRONMENT</p>
  <div class="sub">TYPE 1 DIABETES MELLITUS</div>
  <button class="btn btn-primary" id="playBtn"><span>Enter Lab</span></button>
</div>
<div id="labOptions" style="display:none;">
  <h2>Lab Setup</h2>
  <button class="btn btn-secondary" id="notesBtn">Insert Notes</button>
  <button class="btn btn-secondary" id="filesBtn">Upload Files</button>
  <input type="file" id="fileInput" style="display:none;" multiple>
  <br><br>
  <button class="btn btn-primary" id="skipBtn"><span>Skip → Enter Lab</span></button>
</div>
<div id="hud">
  <span><span class="key">Click Floor</span> Move</span>
  <span><span class="key">Q / E</span> Turn</span>
  <span><span class="key">5</span> Toggle View</span>
  <span><span class="key">Click Label</span> Inspect Drug</span>
  <span><span class="key">Click Board</span> Patient Chart</span>
</div>
<div id="modeIndicator">FIRST PERSON</div>

<div id="drugPanel">
  <div id="dph">
    <div><div id="dptitle">—</div><div id="dpclass">—</div></div>
    <button id="closeDrug">✕</button>
  </div>
  <div id="dpbody">
    <div class="ds">INDICATION</div><div class="dd" id="dpind">—</div>
    <div class="ds">DOSAGE</div><div class="dd" id="dpdose">—</div>
    <div class="ds">SIDE EFFECTS</div><div id="dpse">—</div>
    <div class="ds">MONITORING</div><div class="dd" id="dpmon">—</div>
  </div>
  <div id="dpmech">—</div>
  <div id="dpActions">
    <button id="adminBtn">ADMINISTER TO PATIENT</button>
  </div>
</div>

<div id="regimenPanel">
  <div class="rp-head">
    <div class="rp-title">PATIENT REGIMEN</div>
    <div class="rp-sub">T1DM — 22yr F — New Dx</div>
  </div>
  <div class="rp-body" id="regimenBody">
    <div class="rp-empty">No drugs administered yet</div>
  </div>
  <button id="checkRegimenBtn">CHECK REGIMEN</button>
  <div id="regimenFeedback"></div>
</div>

<div id="toast"></div>

<div id="patientPanel">
  <div id="pph">
    <div><div id="pptitle">PATIENT CHART</div><div id="ppsubtitle">SARAH M. · 22yr F · T1DM New Dx</div></div>
    <button id="closePatient">✕</button>
  </div>
  <div id="ppbody">
    <div class="ds">PRESENTING COMPLAINT</div>
    <div class="dd" id="ppPresenting"></div>
    <div class="ds">VITALS</div>
    <div class="dd" id="ppVitals"></div>
    <div class="ds">KEY LABS</div>
    <div id="ppLabs"></div>
    <div class="ds">AUTOANTIBODIES</div>
    <div class="dd" id="ppAb"></div>
    <div class="ds">DIAGNOSIS</div>
    <div class="dd" id="ppDx"></div>
    <div class="ds">MANAGEMENT PLAN</div>
    <div class="dd" id="ppPlan" style="white-space:pre-line;"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
// ─── TYPE 1 DIABETES DRUG DATA ─────────────────────────────────
// correct=true → appropriate for this T1DM patient (new-onset DKA → long-term management)
// correct=false → TRAP / wrong choice with penalty reason
const DRUGS=[
  // ── CORRECT: ACUTE DKA MANAGEMENT ──
  {name:"IV INSULIN DRIP",cls:"REGULAR INSULIN · CONTINUOUS INFUSION",col:0xcc3333,lc:"#ff6655",category:"iv_insulin",correct:true,
   ind:"DKA first-line: IV regular insulin infusion to resolve ketoacidosis. This patient presented in DKA (pH 7.18, bicarb 9).",
   dose:"0.1 U/kg/hr continuous IV infusion (no bolus per current guidelines). Titrate to BG drop of 50–75 mg/dL/hr.",
   se:[["Hypoglycemia (monitor hourly)","w"],["Hypokalemia (replace K⁺ first if <3.3)","w"],["Cerebral edema (rare, peds)","w"],["Fluid shifts",""]],
   mon:"BG hourly. BMP q2–4hr (K⁺, bicarb, anion gap). Transition to SC insulin when gap closes, pH >7.3, bicarb >15, patient eating.",
   mech:"Regular insulin IV has immediate onset. Suppresses lipolysis → stops ketogenesis. Drives glucose into cells. Closes anion gap. Must bridge to SC basal-bolus before stopping drip (overlap 2hr)."},

  {name:"IV NORMAL SALINE",cls:"0.9% NaCl · FLUID RESUSCITATION",col:0x2266aa,lc:"#4488dd",category:"iv_fluids",correct:true,
   ind:"DKA causes severe dehydration (avg 5–7L deficit). This patient: HR 112, BP 98/62 — hemodynamically unstable.",
   dose:"1–1.5 L/hr for first 1–2hr, then 250–500 mL/hr. Switch to 0.45% NaCl when Na corrects. Add D5 when BG <200.",
   se:[["Fluid overload (monitor I/O)","w"],["Hyperchloremic acidosis (large volumes)",""],["Pulmonary edema (rare)","w"]],
   mon:"Strict I/O, vitals q1hr, Na⁺ and osmolality, urine output >0.5 mL/kg/hr. Switch to half-NS when appropriate.",
   mech:"Restores intravascular volume and renal perfusion. Corrects dehydration-driven hemoconcentration. Essential first step — give fluids BEFORE insulin if K⁺ <3.3."},

  {name:"IV POTASSIUM (KCl)",cls:"ELECTROLYTE REPLACEMENT",col:0xdd8811,lc:"#ffbb44",category:"potassium",correct:true,
   ind:"DKA causes total body K⁺ depletion despite serum K⁺ appearing normal/high. Insulin drives K⁺ intracellularly → fatal hypokalemia.",
   dose:"If K⁺ <3.3: hold insulin, give 40 mEq/hr. If 3.3–5.3: 20–40 mEq per liter of IV fluid. If >5.3: recheck in 2hr.",
   se:[["Hyperkalemia if over-replaced","w"],["IV site burning/phlebitis",""],["Cardiac arrhythmia if given too fast","w"]],
   mon:"K⁺ q2hr during DKA. Continuous cardiac monitoring. Replace K⁺ BEFORE starting insulin if <3.3. Target 4–5 mEq/L.",
   mech:"Insulin + fluid resuscitation both shift K⁺ into cells. Without replacement, fatal hypokalemia → cardiac arrest. Most dangerous part of DKA management."},

  // ── CORRECT: LONG-TERM T1DM MANAGEMENT ──
  {name:"INSULIN GLARGINE",cls:"LONG-ACTING BASAL INSULIN (SC)",col:0x884400,lc:"#ffaa44",category:"basal",correct:true,
   ind:"T1DM — essential basal insulin for transition off IV drip. Provides 24hr peakless coverage. Lifelong therapy.",
   dose:"Start 0.2 U/kg/day SC once daily. Give 2hr BEFORE stopping IV insulin drip. Titrate to fasting BG 80–130.",
   se:[["Hypoglycemia","w"],["Weight gain",""],["Injection site lipodystrophy",""],["Hypokalemia","w"]],
   mon:"Fasting glucose daily. HbA1c q3 months. Potassium. Injection site rotation.",
   mech:"Ultra-long acting insulin analogue. Forms microprecipitates at injection site → slow 24hr release. Binds insulin receptor → GLUT4 translocation → cellular glucose uptake. Replaces what β-cells can no longer make."},

  {name:"INSULIN LISPRO",cls:"RAPID-ACTING BOLUS INSULIN (SC)",col:0x2255aa,lc:"#44aaff",category:"bolus",correct:true,
   ind:"T1DM — mealtime bolus insulin. Inject 15 min before meals. Essential for postprandial glucose coverage + corrections.",
   dose:"Carb ratio: ~1U per 10–15g carbs (individualize). Correction factor: ~1U per 50 mg/dL above target. Start conservative.",
   se:[["Hypoglycemia (significant)","w"],["Weight gain",""],["Hypokalemia","w"],["Injection site lipodystrophy",""]],
   mon:"Pre/post-meal glucose. Carb counting accuracy. HbA1c q3 months. Rotate injection sites.",
   mech:"Rapid-acting insulin analogue (onset 15 min, peak 1hr, duration 3–5hr). Reversed Pro-Lys at B28-29 → faster absorption. Covers postprandial glucose spikes from meals."},

  {name:"GLUCAGON KIT",cls:"EMERGENCY RESCUE · COUNTER-REGULATORY",col:0xaa2222,lc:"#ff5544",category:"emergency",correct:true,
   ind:"Severe hypoglycemia rescue when patient cannot take oral glucose. EVERY T1DM patient must carry this.",
   dose:"1 mg IM/SC (adult). Nasal glucagon: 3 mg one spray. Dasiglucagon auto-injector: 0.6 mg SC. Teach family/friends.",
   se:[["Nausea/vomiting","w"],["Rebound hyperglycemia",""],["Ineffective if glycogen depleted (alcohol, liver dz)","w"]],
   mon:"Consciousness recovery within 15 min. Follow with oral carbs once awake. Replace kit after every use.",
   mech:"Activates hepatic glucagon receptor → cAMP → glycogenolysis + gluconeogenesis → rapid BG elevation. Life-saving for unconscious hypoglycemia."},

  {name:"CGM SYSTEM",cls:"CONTINUOUS GLUCOSE MONITORING",col:0x117744,lc:"#33dd88",category:"cgm",correct:true,
   ind:"T1DM standard of care. Real-time interstitial glucose q1–5 min. Reduces hypo risk by 50%. Enables trend-based dosing.",
   dose:"Sensor insertion SC every 7–14 days (Dexcom G7 / Libre 3). No fingerstick calibration needed on newer devices.",
   se:[["Skin irritation / adhesive allergy",""],["Sensor inaccuracy (compression lows, day 1)",""],["Alarm fatigue",""],["Cost / insurance barriers",""]],
   mon:"Time-in-range target >70% (70–180 mg/dL). Time below range <4%. GMI (glucose management indicator). Review AGP reports.",
   mech:"Electrochemical sensor measures interstitial glucose via glucose oxidase. Transmits wirelessly to phone/receiver. Trend arrows guide insulin dosing. Alerts prevent dangerous lows overnight."},

  // ── TRAP / INCORRECT CHOICES ──
  {name:"METFORMIN",cls:"BIGUANIDE · FIRST-LINE T2DM",col:0x226644,lc:"#44cc88",category:"trap_oral",correct:false,
   penalty:"Metformin targets hepatic insulin resistance — T1DM is caused by absolute insulin deficiency from β-cell destruction. Metformin cannot replace insulin and is contraindicated during DKA (lactic acidosis risk).",
   ind:"Type 2 DM first-line oral agent. Also prediabetes, PCOS. NOT indicated for T1DM.",
   dose:"500–2000 mg/day orally in divided doses with meals.",
   se:[["GI upset (nausea, diarrhea)","w"],["Lactic acidosis (rare, CI in DKA)","w"],["B12 deficiency (long-term)","w"]],
   mon:"eGFR annually. Hold before IV contrast. CI: eGFR <30, active DKA, hepatic failure.",
   mech:"Activates AMPK → inhibits hepatic gluconeogenesis. Reduces insulin resistance. Does NOT provide exogenous insulin — useless when β-cells are destroyed."},

  {name:"GLIPIZIDE",cls:"SULFONYLUREA (2ND GEN)",col:0x887722,lc:"#ddcc44",category:"trap_su",correct:false,
   penalty:"Sulfonylureas force β-cells to release insulin — but this patient's β-cells are destroyed by autoimmune attack. There is nothing to stimulate. Dangerous: can cause unpredictable hypoglycemia if combined with injected insulin.",
   ind:"T2DM — stimulates endogenous insulin secretion. CONTRAINDICATED in T1DM (no functional β-cells).",
   dose:"5 mg once daily before breakfast. Max 40 mg/day.",
   se:[["Hypoglycemia (significant)","w"],["Weight gain",""],["Agranulocytosis (rare)","w"]],
   mon:"Fasting glucose, HbA1c, weight, renal function.",
   mech:"Binds SUR1 on β-cell → K-ATP channel closure → depolarisation → Ca²⁺ influx → insulin exocytosis. REQUIRES FUNCTIONAL β-CELLS — absent in T1DM."},

  {name:"SEMAGLUTIDE",cls:"GLP-1 RECEPTOR AGONIST (OZEMPIC)",col:0x993311,lc:"#ff7744",category:"trap_glp1",correct:false,
   penalty:"GLP-1 RAs work by enhancing glucose-dependent insulin secretion from β-cells — which are destroyed in T1DM. Not FDA-approved for T1DM. Does NOT replace insulin and may increase DKA risk.",
   ind:"T2DM with obesity or CVD. Weight management (Wegovy). NOT approved or effective for T1DM.",
   dose:"0.5–2 mg SC weekly (Ozempic). Titrate slowly over months.",
   se:[["Nausea/vomiting (early)","w"],["Thyroid C-cell tumors (MEN2 CI)","w"],["Pancreatitis","w"],["Appetite reduction",""]],
   mon:"Weight, HbA1c, thyroid history, renal function.",
   mech:"GLP-1 RA → glucose-dependent insulin secretion + glucagon suppression. REQUIRES residual β-cell function — not present in established T1DM. A popular drug but wrong for this patient."},

  {name:"PIOGLITAZONE",cls:"THIAZOLIDINEDIONE (TZD)",col:0x115566,lc:"#33aacc",category:"trap_tzd",correct:false,
   penalty:"TZDs improve peripheral insulin sensitivity — but this patient's problem is NO insulin production, not resistance to it. Adds dangerous fluid retention (worsens DKA dehydration) and fracture risk.",
   ind:"T2DM insulin resistance. Also NASH. NOT appropriate for T1DM — does not address insulin deficiency.",
   dose:"15–45 mg orally once daily.",
   se:[["Fluid retention / edema","w"],["Weight gain",""],["Bone fractures (women)","w"],["Heart failure exacerbation","w"]],
   mon:"LFTs, weight, edema, bone density, cardiac status.",
   mech:"PPAR-γ agonist → ↑adiponectin → improved insulin sensitivity. Does NOT provide exogenous insulin. In DKA, fluid retention is actively harmful."},

  {name:"EMPAGLIFLOZIN",cls:"SGLT-2 INHIBITOR (JARDIANCE)",col:0x226633,lc:"#44dd88",category:"trap_sglt2",correct:false,
   penalty:"SGLT-2 inhibitors cause euglycemic DKA in T1DM — the most dangerous trap. Blood glucose appears NORMAL while the patient develops life-threatening ketoacidosis. Absolutely contraindicated here.",
   ind:"T2DM + CVD or CKD. NOT approved for T1DM — high risk of euglycemic DKA.",
   dose:"10–25 mg orally once daily.",
   se:[["Euglycemic DKA (HIGH RISK in T1DM!)","w"],["Genital mycotic infections","w"],["Volume depletion","w"],["Fournier's gangrene (rare)","w"]],
   mon:"eGFR, BP, ketones. In T1DM: ketone monitoring is critical but this drug should NOT be used.",
   mech:"Blocks SGLT-2 → glucosuria. In T1DM: reduced insulin + glucosuria → shifts metabolism to ketogenesis → DKA with deceptively normal BG. The most dangerous wrong answer."}
];

// ─── PATIENT DATA ──────────────────────────────────────────────
const PATIENT={
  name:"SARAH M.",age:22,sex:"F",dx:"New-onset Type 1 Diabetes Mellitus",
  hba1c:"11.2%",fbg:"286 mg/dL",cpeptide:"< 0.1 ng/mL",
  antibodies:"GAD65+, IA-2+, ZnT8+",
  presenting:"3-week history: polyuria, polydipsia, 8 kg weight loss, fatigue, blurred vision. Presented to ED with nausea & fruity breath. BG 486 mg/dL, pH 7.18, bicarb 9.",
  vitals:"HR 112, BP 98/62, RR 28 (Kussmaul), T 37.1°C, BMI 19.2",
  plan:"1) Resolve DKA: IV insulin drip + fluids\n2) Transition to basal-bolus regimen\n3) Initiate CGM\n4) Diabetes education + carb counting\n5) Glucagon rescue kit\n6) Endo + ophthalmology referral"
};

const SYMPTOMS={
  t1:["Polyuria — osmotic diuresis from hyperglycemia","Polydipsia — compensatory fluid intake","Polyphagia with paradoxical weight loss","DKA: fruity breath, Kussmaul breathing, AMS","Onset: abrupt, typically children/young adults","Autoimmune β-cell destruction (>90% loss at Dx)"],
  path:["Genetic susceptibility: HLA-DR3/DR4","Environmental trigger (viral? molecular mimicry)","Insulitis — T-cell mediated β-cell destruction","Progressive insulin deficiency","Absolute insulin dependence for survival","C-peptide absent or near-zero"],
  mgmt:["Basal-bolus insulin (MDI or pump/CSII)","Carbohydrate counting + insulin-to-carb ratio","CGM ± closed-loop / hybrid systems","HbA1c target < 7% (individualize)","Hypoglycemia education + glucagon kit","Screen for celiac, thyroid (autoimmune comorbid)"]
};

// ─── REGIMEN SYSTEM ────────────────────────────────────────────
let patientRegimen=[];
let currentDrug=null;

function addToRegimen(drug){
  if(patientRegimen.find(d=>d.name===drug.name)){showToast(drug.name+" already administered","error");return;}
  patientRegimen.push(drug);
  updateRegimenUI();
  if(drug.correct===false){
    showToast(drug.name+" administered — are you sure?","warning");
  } else {
    showToast(drug.name+" administered ✓","success");
  }
}

function removeFromRegimen(name){
  patientRegimen=patientRegimen.filter(d=>d.name!==name);
  updateRegimenUI();
}

function updateRegimenUI(){
  const body=document.getElementById("regimenBody");
  const fb=document.getElementById("regimenFeedback");
  fb.innerHTML='';
  if(patientRegimen.length===0){
    body.innerHTML='<div class="rp-empty">No drugs administered yet</div>';
    return;
  }
  body.innerHTML=patientRegimen.map(d=>{
    const isWrong=d.correct===false;
    const nameCol=isWrong?'#ffaa88':'#c0e0ff';
    const catLabel=isWrong?'⚠ '+d.cls.split('·')[0].trim():d.category.toUpperCase();
    const catCol=isWrong?'#ff886688':'#00e5ff88';
    return `<div class="regimen-item" style="${isWrong?'border-left:2px solid #ff664488;padding-left:6px;':''}">
      <div><div class="ri-name" style="color:${nameCol}">${d.name}</div><div class="ri-dose" style="color:${catCol}">${catLabel}</div></div>
      <button class="ri-remove" onclick="removeFromRegimen('${d.name}')">✕</button>
    </div>`;
  }).join('');
}

function checkRegimen(){
  const fb=document.getElementById("regimenFeedback");
  let msgs=[];
  let score=0;
  let penalties=0;

  // Check for WRONG choices first
  const wrongDrugs=patientRegimen.filter(d=>d.correct===false);
  const correctDrugs=patientRegimen.filter(d=>d.correct===true);

  wrongDrugs.forEach(d=>{
    msgs.push('✗ '+d.name+' — INCORRECT: '+d.penalty);
    penalties+=15;
  });

  // ── ACUTE DKA PHASE ──
  const cats=correctDrugs.map(d=>d.category);
  const hasIVinsulin=cats.includes("iv_insulin");
  const hasIVfluids=cats.includes("iv_fluids");
  const hasPotassium=cats.includes("potassium");

  if(hasIVinsulin){msgs.push('✓ IV insulin drip — first-line for DKA resolution');score+=15;}
  else msgs.push('✗ MISSING IV insulin — cannot resolve DKA without it!');

  if(hasIVfluids){msgs.push('✓ IV NS fluids — corrects severe dehydration (5–7L deficit)');score+=10;}
  else msgs.push('✗ MISSING IV fluids — patient is hemodynamically unstable (BP 98/62)!');

  if(hasPotassium){msgs.push('✓ IV potassium — prevents fatal hypokalemia during insulin therapy');score+=10;}
  else msgs.push('✗ MISSING K⁺ replacement — insulin will drive K⁺ into cells → cardiac arrest!');

  // ── LONG-TERM MANAGEMENT ──
  const hasBasal=cats.includes("basal");
  const hasBolus=cats.includes("bolus");
  const hasEmergency=cats.includes("emergency");
  const hasCGM=cats.includes("cgm");

  if(hasBasal){msgs.push('✓ Basal insulin (SC) — essential lifelong T1DM therapy');score+=15;}
  else msgs.push('✗ MISSING basal insulin — patient needs SC basal before DC');

  if(hasBolus){msgs.push('✓ Bolus insulin (SC) — mealtime coverage for carb intake');score+=15;}
  else msgs.push('✗ MISSING bolus insulin — severe postprandial hyperglycemia');

  if(hasEmergency){msgs.push('✓ Glucagon rescue kit — critical safety net for severe hypos');score+=10;}
  else msgs.push('⚠ Consider glucagon kit — every T1DM patient should carry one');

  if(hasCGM){msgs.push('✓ CGM — standard of care, reduces hypo risk by ~50%');score+=10;}
  else msgs.push('⚠ CGM strongly recommended — improves time-in-range');

  // Cap score after penalties
  score=Math.max(0,score-penalties);
  const maxPossible=85;

  // Determine grade
  let grade,gradeCol;
  if(wrongDrugs.length>=3){grade='DANGEROUS REGIMEN';gradeCol='#ff0000';}
  else if(wrongDrugs.length>0&&score<40){grade='HARMFUL REGIMEN';gradeCol='#ff2222';}
  else if(wrongDrugs.length>0){grade='ERRORS IN REGIMEN';gradeCol='#ff6644';}
  else if(score>=80){grade='EXCELLENT';gradeCol='#44ff88';}
  else if(score>=60){grade='GOOD';gradeCol='#88dd66';}
  else if(score>=40){grade='INCOMPLETE';gradeCol='#ffcc44';}
  else if(score>=20){grade='MAJOR GAPS';gradeCol='#ff8844';}
  else{grade='CRITICAL — PATIENT AT RISK';gradeCol='#ff4444';}

  const correctCount=correctDrugs.length;
  const wrongCount=wrongDrugs.length;

  fb.innerHTML=
    `<div style="color:${gradeCol};font-size:11px;letter-spacing:2px;margin-bottom:4px;font-weight:bold;">REGIMEN: ${grade}</div>`+
    `<div style="color:#888;font-size:9px;margin-bottom:8px;">${correctCount} correct · ${wrongCount} incorrect · Score: ${score}/${maxPossible}</div>`+
    msgs.map(m=>`<div style="color:${m.startsWith('✓')?'#88ffaa':m.startsWith('✗')?'#ff8888':'#ffcc88'};margin:3px 0;font-size:10px;line-height:1.4;">${m}</div>`).join('');
}

function showToast(msg,type){
  const t=document.getElementById("toast");
  t.textContent=msg;
  t.className=type==="error"?"error":type==="warning"?"warning":"";
  t.style.display="block";
  setTimeout(()=>t.style.display="none",2500);
}

// ─── ENTRY SCENE ───────────────────────────────────────────────
const menu=document.getElementById("menu"),labOptions=document.getElementById("labOptions"),labCanvas=document.getElementById("labCanvas"),hud=document.getElementById("hud"),modeIndicator=document.getElementById("modeIndicator");
const eScene=new THREE.Scene(); eScene.background=new THREE.Color(0x050a12); eScene.fog=new THREE.Fog(0x050a12,10,40);
const eCam=new THREE.PerspectiveCamera(60,innerWidth/innerHeight,.1,1000); eCam.position.z=10;
const eRend=new THREE.WebGLRenderer({canvas:labCanvas,antialias:true}); eRend.setSize(innerWidth,innerHeight); eRend.setPixelRatio(Math.min(devicePixelRatio,2));
const pg=new THREE.BufferGeometry(),pp=new Float32Array(600);
for(let i=0;i<200;i++){pp[i*3]=(Math.random()-.5)*30;pp[i*3+1]=(Math.random()-.5)*30;pp[i*3+2]=(Math.random()-.5)*30;}
pg.setAttribute('position',new THREE.BufferAttribute(pp,3));
eScene.add(new THREE.Points(pg,new THREE.PointsMaterial({color:0x00e5ff,size:.08,transparent:true,opacity:.7})));
for(let i=0;i<3;i++){const t=new THREE.Mesh(new THREE.TorusGeometry(2+i*1.5,.04,8,80),new THREE.MeshBasicMaterial({color:[0x00e5ff,0x7c4dff,0x00b8d4][i],transparent:true,opacity:.5-i*.1}));t.rotation.x=Math.PI/3*i;t.rotation.z=Math.PI/4*i;t.userData.speed=.003+i*.002;t.userData.axis=new THREE.Vector3(Math.random(),Math.random(),Math.random()).normalize();eScene.add(t);}
eScene.add(new THREE.AmbientLight(0x00e5ff,.2));
let eRun=true;
function animEntry(){if(!eRun)return;requestAnimationFrame(animEntry);const t=Date.now()*.001;eScene.children.forEach(o=>{if(o.userData.axis)o.rotateOnAxis(o.userData.axis,o.userData.speed);});eCam.position.x=Math.sin(t*.1)*2;eCam.position.y=Math.cos(t*.07);eCam.lookAt(0,0,0);eRend.render(eScene,eCam);}
animEntry();

document.getElementById("playBtn").onclick=()=>{menu.style.display="none";labOptions.style.display="block";};
document.getElementById("notesBtn").onclick=()=>{const n=prompt("Insert clinical notes:");if(n)alert("Saved.");};
const fi=document.getElementById("fileInput");
document.getElementById("filesBtn").onclick=()=>fi.click();
fi.onchange=()=>{labOptions.style.display="none";eRun=false;startLab();};
document.getElementById("skipBtn").onclick=()=>{labOptions.style.display="none";eRun=false;startLab();};

// ─── TEXTURE HELPERS ───────────────────────────────────────────
function makeDrugTex(drug){
  const W=512,H=256,c=document.createElement('canvas');c.width=W;c.height=H;
  const x=c.getContext('2d');
  x.fillStyle='#040c18';x.fillRect(0,0,W,H);
  x.fillStyle=drug.lc;x.globalAlpha=.12;x.fillRect(0,0,W,H);x.globalAlpha=1;
  x.fillStyle=drug.lc;x.fillRect(0,0,W,6);x.fillRect(0,H-6,W,6);
  x.strokeStyle=drug.lc;x.globalAlpha=.5;x.lineWidth=2;x.strokeRect(2,2,W-4,H-4);x.globalAlpha=1;
  x.fillStyle=drug.lc;x.font='bold 36px monospace';x.textAlign='center';x.fillText(drug.name,W/2,58);
  x.fillStyle='#ffffff77';x.font='13px monospace';x.fillText(drug.cls,W/2,80);
  // Category badge
  const catCol={basal:'#ffaa44',bolus:'#44aaff',technology:'#44ddcc',adjunct:'#bb55bb',emergency:'#ff5544'}[drug.category]||'#888';
  x.fillStyle=catCol;x.globalAlpha=.25;
  const bw=x.measureText(drug.category.toUpperCase()).width+20;
  x.fillRect(W/2-bw/2,88,bw,18);x.globalAlpha=1;
  x.fillStyle=catCol;x.font='bold 10px monospace';x.fillText(drug.category.toUpperCase(),W/2,101);

  x.strokeStyle=drug.lc;x.globalAlpha=.25;x.lineWidth=1;x.beginPath();x.moveTo(30,112);x.lineTo(W-30,112);x.stroke();x.globalAlpha=1;
  x.fillStyle='#aaccff';x.font='12px monospace';x.textAlign='center';
  const words=drug.mech.split(' ');let line='',lines=[];
  for(const w of words){const t=line+w+' ';if(x.measureText(t).width>W-60&&line){lines.push(line.trim());line=w+' ';}else line=t;}lines.push(line.trim());
  lines.slice(0,3).forEach((l,i)=>x.fillText(l,W/2,130+i*17));
  x.fillStyle=drug.lc;x.globalAlpha=.7;x.font='11px monospace';x.fillText('[ CLICK TO INSPECT ]',W/2,H-14);x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

function makeBillTex(){
  const W=1280,H=800,c=document.createElement('canvas');c.width=W;c.height=H;
  const x=c.getContext('2d');
  x.fillStyle='#020810';x.fillRect(0,0,W,H);
  const g=x.createLinearGradient(0,0,W,H);g.addColorStop(0,'#00e5ff');g.addColorStop(.5,'#7c4dff');g.addColorStop(1,'#00e5ff');
  x.strokeStyle=g;x.lineWidth=4;x.strokeRect(4,4,W-8,H-8);x.lineWidth=1;x.globalAlpha=.25;x.strokeRect(12,12,W-24,H-24);x.globalAlpha=1;
  x.fillStyle='#00e5ff';x.font='bold 44px monospace';x.textAlign='center';x.fillText('TYPE 1 DIABETES MELLITUS',W/2,58);
  x.fillStyle='#ffffff55';x.font='15px monospace';x.fillText('AUTOIMMUNE β-CELL DESTRUCTION · ABSOLUTE INSULIN DEFICIENCY',W/2,83);
  x.strokeStyle='#00e5ff44';x.lineWidth=1;x.beginPath();x.moveTo(40,98);x.lineTo(W-40,98);x.stroke();
  const cols=[
    {x:W*.18,label:'PRESENTATION',color:'#55aaff',data:SYMPTOMS.t1},
    {x:W*.5,label:'PATHOPHYSIOLOGY',color:'#ff8844',data:SYMPTOMS.path},
    {x:W*.82,label:'MANAGEMENT',color:'#44ee88',data:SYMPTOMS.mgmt}
  ];
  cols.forEach(col=>{
    x.fillStyle=col.color;x.font='bold 19px monospace';x.textAlign='center';x.fillText(col.label,col.x,128);
    x.strokeStyle=col.color;x.globalAlpha=.3;x.lineWidth=1;x.beginPath();x.moveTo(col.x-155,138);x.lineTo(col.x+155,138);x.stroke();x.globalAlpha=1;
    col.data.forEach((item,ii)=>{
      const y=162+ii*97;
      x.fillStyle=col.color;x.globalAlpha=.9;x.beginPath();x.arc(col.x-150,y+5,5,0,Math.PI*2);x.fill();x.globalAlpha=1;
      x.textAlign='left';
      const words=item.split(' ');let line='',lines=[];
      x.font='13px monospace';
      for(const w of words){const t=line+w+' ';if(x.measureText(t).width>270&&line){lines.push(line.trim());line=w+' ';}else line=t;}lines.push(line.trim());
      lines.forEach((l,li)=>{
        x.fillStyle=li===0?'#d8eeff':'#7aaccc';x.font='13px monospace';x.fillText(l,col.x-140,y+li*16);
      });
    });
  });
  x.fillStyle='#ffffff33';x.font='13px monospace';x.textAlign='center';
  x.fillText('Dx: C-peptide ↓ · GAD65/IA-2/ZnT8 Ab+ · HbA1c ≥ 6.5% · Requires lifelong exogenous insulin',W/2,H-18);
  return new THREE.CanvasTexture(c);
}

function makePatientTex(){
  const W=1280,H=800,c=document.createElement('canvas');c.width=W;c.height=H;
  const x=c.getContext('2d');
  x.fillStyle='#020810';x.fillRect(0,0,W,H);
  // Border
  const g=x.createLinearGradient(0,0,W,H);g.addColorStop(0,'#ff8844');g.addColorStop(.5,'#ff4488');g.addColorStop(1,'#ff8844');
  x.strokeStyle=g;x.lineWidth=3;x.strokeRect(4,4,W-8,H-8);

  // Title
  x.fillStyle='#ff8844';x.font='bold 36px monospace';x.textAlign='center';x.fillText('PATIENT PRESENTATION',W/2,50);
  x.fillStyle='#ffffff44';x.font='14px monospace';x.fillText(PATIENT.name+' · '+PATIENT.age+'yr '+PATIENT.sex+' · '+PATIENT.dx,W/2,75);

  // Draw patient silhouette on left
  const sx=220,sy=160; // silhouette center
  x.save();
  x.fillStyle='#ff884422';
  x.strokeStyle='#ff884488';
  x.lineWidth=2;
  // Head
  x.beginPath();x.arc(sx,sy,42,0,Math.PI*2);x.fill();x.stroke();
  // Neck
  x.fillRect(sx-12,sy+42,24,20);x.strokeRect(sx-12,sy+42,24,20);
  // Torso
  x.beginPath();x.moveTo(sx-55,sy+62);x.lineTo(sx+55,sy+62);x.lineTo(sx+45,sy+220);x.lineTo(sx-45,sy+220);x.closePath();x.fill();x.stroke();
  // Arms
  x.beginPath();x.moveTo(sx-55,sy+62);x.lineTo(sx-85,sy+180);x.lineTo(sx-70,sy+185);x.lineTo(sx-45,sy+90);x.closePath();x.fill();x.stroke();
  x.beginPath();x.moveTo(sx+55,sy+62);x.lineTo(sx+85,sy+180);x.lineTo(sx+70,sy+185);x.lineTo(sx+45,sy+90);x.closePath();x.fill();x.stroke();
  // Legs
  x.beginPath();x.moveTo(sx-45,sy+220);x.lineTo(sx-50,sy+370);x.lineTo(sx-25,sy+372);x.lineTo(sx-8,sy+225);x.closePath();x.fill();x.stroke();
  x.beginPath();x.moveTo(sx+45,sy+220);x.lineTo(sx+50,sy+370);x.lineTo(sx+25,sy+372);x.lineTo(sx+8,sy+225);x.closePath();x.fill();x.stroke();

  // Annotation arrows pointing to body parts
  const annots=[
    {x:sx,y:sy-55,label:"Blurred vision",tx:sx+120,ty:sy-50},
    {x:sx,y:sy+5,label:"Fruity breath (DKA)",tx:sx+120,ty:sy+10},
    {x:sx+65,y:sy+130,label:"Weight loss: -8 kg",tx:sx+130,ty:sy+130},
    {x:sx-65,y:sy+130,label:"Kussmaul breathing",tx:sx-230,ty:sy+130},
    {x:sx,y:sy+290,label:"Polyuria / dehydration",tx:sx+130,ty:sy+290},
    {x:sx-70,y:sy+190,label:"SC insulin sites →",tx:sx-250,ty:sy+190},
  ];
  x.font='11px monospace';
  annots.forEach(a=>{
    x.strokeStyle='#ff884466';x.lineWidth=1;
    x.beginPath();x.moveTo(a.x,a.y);x.lineTo(a.tx,a.ty);x.stroke();
    x.fillStyle='#ffccaa';x.textAlign=a.tx<sx?'right':'left';
    x.fillText(a.label,a.tx+(a.tx<sx?-6:6),a.ty+4);
  });

  // Vital signs / labs panel on right
  const rx=720,ry=100;
  x.textAlign='left';
  x.fillStyle='#ff884499';x.font='bold 16px monospace';x.fillText('VITALS',rx,ry);
  x.fillStyle='#ccddff';x.font='12px monospace';
  PATIENT.vitals.split(', ').forEach((v,i)=>x.fillText(v,rx,ry+22+i*18));

  const ly=ry+130;
  x.fillStyle='#ff884499';x.font='bold 16px monospace';x.fillText('KEY LABS',rx,ly);
  x.fillStyle='#ff6666';x.font='12px monospace';
  x.fillText('HbA1c: '+PATIENT.hba1c+' (↑↑)',rx,ly+22);
  x.fillText('Fasting BG: '+PATIENT.fbg+' (↑↑)',rx,ly+40);
  x.fillStyle='#44aaff';
  x.fillText('C-peptide: '+PATIENT.cpeptide+' (↓↓)',rx,ly+58);
  x.fillText('Antibodies: '+PATIENT.antibodies,rx,ly+76);

  const py=ly+120;
  x.fillStyle='#ff884499';x.font='bold 16px monospace';x.fillText('PRESENTING COMPLAINT',rx,py);
  x.fillStyle='#bbccdd';x.font='11px monospace';
  const pwords=PATIENT.presenting.split(' ');let pline='',plines=[];
  for(const w of pwords){const t=pline+w+' ';if(x.measureText(t).width>480&&pline){plines.push(pline.trim());pline=w+' ';}else pline=t;}plines.push(pline.trim());
  plines.forEach((l,i)=>x.fillText(l,rx,py+20+i*16));

  const my=py+20+plines.length*16+30;
  x.fillStyle='#44ee88aa';x.font='bold 16px monospace';x.fillText('MANAGEMENT PLAN',rx,my);
  x.fillStyle='#aaddbb';x.font='11px monospace';
  PATIENT.plan.split('\n').forEach((l,i)=>x.fillText(l,rx,my+20+i*18));

  // Click hint at bottom
  x.restore();
  x.fillStyle='#ff8844';x.globalAlpha=.7;x.font='bold 13px monospace';x.textAlign='center';
  x.fillText('[ CLICK BOARD TO OPEN FULL PATIENT CHART ]',W/2,H-16);
  x.globalAlpha=1;
  return new THREE.CanvasTexture(c);
}

// ─── MAIN LAB ──────────────────────────────────────────────────
function startLab(){
  hud.style.display="block";modeIndicator.style.display="block";
  document.getElementById("regimenPanel").style.display="block";
  const scene=new THREE.Scene();scene.background=new THREE.Color(0x0a0f1a);scene.fog=new THREE.FogExp2(0x0a0f1a,.015);
  const camera=new THREE.PerspectiveCamera(75,innerWidth/innerHeight,.1,200);camera.position.set(0,3.2,12);
  const renderer=new THREE.WebGLRenderer({canvas:labCanvas,antialias:true});
  renderer.setSize(innerWidth,innerHeight);renderer.setPixelRatio(Math.min(devicePixelRatio,2));
  renderer.shadowMap.enabled=true;renderer.shadowMap.type=THREE.PCFSoftShadowMap;
  renderer.toneMapping=THREE.ACESFilmicToneMapping;renderer.toneMappingExposure=.9;

  // Lighting
  scene.add(new THREE.AmbientLight(0x1a2a4a,1.2));
  [[-12,7,-12],[0,7,-12],[12,7,-12],[-12,7,0],[0,7,0],[12,7,0],[-12,7,12],[0,7,12],[12,7,12]].forEach(([x,y,z])=>{
    const l=new THREE.PointLight(0xd0eeff,.8,20);l.position.set(x,y,z);l.castShadow=true;l.shadow.mapSize.width=512;l.shadow.mapSize.height=512;scene.add(l);
    const s=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,2.5,8),new THREE.MeshBasicMaterial({color:0xd0eeff,transparent:true,opacity:.9}));s.rotation.z=Math.PI/2;s.position.set(x,7.15,z);scene.add(s);
  });
  const tl=new THREE.PointLight(0x00e5ff,.4,30);tl.position.set(-18,3,-18);scene.add(tl);
  const pl2=new THREE.PointLight(0x7c4dff,.3,30);pl2.position.set(18,3,18);scene.add(pl2);

  // Room
  const RW=52,RH=9,RD=52;
  const room=new THREE.Mesh(new THREE.BoxGeometry(RW,RH,RD),new THREE.MeshStandardMaterial({color:0xc8d4e0,roughness:.85,side:THREE.BackSide}));
  room.position.y=RH/2;room.receiveShadow=true;scene.add(room);
  const aM=new THREE.MeshBasicMaterial({color:0x00e5ff,transparent:true,opacity:.3});
  [{p:[0,8.3,-RD/2+.1],s:[RW,.06,.12]},{p:[0,8.3,RD/2-.1],s:[RW,.06,.12]},{p:[-RW/2+.1,8.3,0],s:[.12,.06,RD]},{p:[RW/2-.1,8.3,0],s:[.12,.06,RD]}].forEach(({p,s})=>{const m=new THREE.Mesh(new THREE.BoxGeometry(...s),aM);m.position.set(...p);scene.add(m);});

  // Floor
  function mkFloorTex(){const c=document.createElement('canvas');c.width=c.height=512;const x=c.getContext('2d');const ts=64;for(let tx=0;tx<8;tx++)for(let ty=0;ty<8;ty++){x.fillStyle=(tx+ty)%2===0?'#b8c8d4':'#a8b8c4';x.fillRect(tx*ts,ty*ts,ts,ts);x.strokeStyle='#8898a4';x.lineWidth=2;x.strokeRect(tx*ts+1,ty*ts+1,ts-2,ts-2);}const t=new THREE.CanvasTexture(c);t.wrapS=t.wrapT=THREE.RepeatWrapping;t.repeat.set(6,6);return t;}
  const floor=new THREE.Mesh(new THREE.PlaneGeometry(RW,RD),new THREE.MeshStandardMaterial({map:mkFloorTex(),roughness:.3,metalness:.1}));
  floor.rotation.x=-Math.PI/2;floor.receiveShadow=true;scene.add(floor);

  // Tables + drug labels
  const labelMeshes=[];
  const tPos=[[-18,-12],[-8,-12],[2,-12],[12,-12],[-18,3],[-8,3],[2,3],[12,3],[-18,16],[-8,16],[2,16],[12,16]];

  tPos.forEach(([tx,tz],i)=>{
    const drug=DRUGS[i]||null;
    // Table top
    const top=new THREE.Mesh(new THREE.BoxGeometry(3.2,.08,1.8),new THREE.MeshStandardMaterial({color:0xf0f4f8,roughness:.3,metalness:.05}));
    top.position.x=tx;top.position.y=1.84;top.position.z=tz;top.castShadow=true;scene.add(top);
    // Cabinet
    const cab=new THREE.Mesh(new THREE.BoxGeometry(3,.9,1.6),new THREE.MeshStandardMaterial({color:0x9aafbf,roughness:.6}));
    cab.position.x=tx;cab.position.y=1.3;cab.position.z=tz;cab.castShadow=true;scene.add(cab);
    // Cabinet doors
    [-0.76,.76].forEach(dx=>{const d=new THREE.Mesh(new THREE.BoxGeometry(1.38,.82,.04),new THREE.MeshStandardMaterial({color:0xb0c4d4,roughness:.4}));d.position.x=tx+dx;d.position.y=1.3;d.position.z=tz+.82;scene.add(d);});
    // Legs
    [[-1.4,.7],[1.4,.7],[-1.4,-.7],[1.4,-.7]].forEach(([lx,lz])=>{const leg=new THREE.Mesh(new THREE.BoxGeometry(.07,.84,.07),new THREE.MeshStandardMaterial({color:0xd0d8e0,roughness:.3,metalness:.7}));leg.position.x=tx+lx;leg.position.y=.42;leg.position.z=tz+lz;scene.add(leg);});
    // Beaker + liquid
    const bk=new THREE.Mesh(new THREE.CylinderGeometry(.09,.07,.22,12),new THREE.MeshStandardMaterial({color:0x88c8ff,transparent:true,opacity:.45}));
    bk.position.x=tx-.5;bk.position.y=1.97;bk.position.z=tz+.2;scene.add(bk);
    if(drug){
      const lc=new THREE.Color(drug.col);
      const lq=new THREE.Mesh(new THREE.CylinderGeometry(.075,.06,.12,12),new THREE.MeshStandardMaterial({color:lc,transparent:true,opacity:.85,emissive:lc,emissiveIntensity:.4}));
      lq.position.x=tx-.5;lq.position.y=1.91;lq.position.z=tz+.2;scene.add(lq);
      const gl=new THREE.PointLight(new THREE.Color(drug.col),0.4,4);
      gl.position.x=tx;gl.position.y=2.5;gl.position.z=tz;scene.add(gl);
    }
    // Petri dish
    const dish=new THREE.Mesh(new THREE.CylinderGeometry(.14,.14,.03,16),new THREE.MeshStandardMaterial({color:0xeef4ff,transparent:true,opacity:.5}));
    dish.position.x=tx+.4;dish.position.y=1.855;dish.position.z=tz-.2;scene.add(dish);
    // Drug label
    if(drug){
      const labelMesh=new THREE.Mesh(new THREE.PlaneGeometry(3,1.5),new THREE.MeshBasicMaterial({map:makeDrugTex(drug),transparent:true,side:THREE.DoubleSide,depthWrite:false}));
      labelMesh.position.x=tx;labelMesh.position.y=3.1;labelMesh.position.z=tz;
      labelMesh.userData.drug=drug;
      scene.add(labelMesh);
      labelMeshes.push(labelMesh);
      const gf=new THREE.Mesh(new THREE.PlaneGeometry(3.15,1.6),new THREE.MeshBasicMaterial({color:new THREE.Color(drug.col),transparent:true,opacity:.07,side:THREE.DoubleSide,depthWrite:false}));
      gf.position.x=tx;gf.position.y=3.1;gf.position.z=tz-.02;scene.add(gf);
    }
  });

  // Wall cabinets
  [-24,-12,0,12,24].forEach(wx=>{
    const cab=new THREE.Mesh(new THREE.BoxGeometry(2.8,1.2,.5),new THREE.MeshStandardMaterial({color:0x9aafc0,roughness:.5}));
    cab.position.x=wx;cab.position.y=6.5;cab.position.z=-RD/2+.5;cab.castShadow=true;scene.add(cab);
  });

  // ── BILLBOARD 1: T1DM Clinical Reference (back wall center-left) ──
  const postM=new THREE.MeshStandardMaterial({color:0x445566,roughness:.4,metalness:.7});
  const bb1x=-13;
  [-4.8,4.8].forEach(dx=>{
    const post=new THREE.Mesh(new THREE.BoxGeometry(.2,5.5,.2),postM);
    post.position.x=bb1x+dx;post.position.y=3.75;post.position.z=-RD/2+1.6;scene.add(post);
  });
  const cb1=new THREE.Mesh(new THREE.BoxGeometry(10.5,.2,.2),postM);cb1.position.x=bb1x;cb1.position.y=6.6;cb1.position.z=-RD/2+1.6;scene.add(cb1);
  const backing1=new THREE.Mesh(new THREE.BoxGeometry(9.8,4.6,.1),new THREE.MeshStandardMaterial({color:0x030c18,roughness:.9}));
  backing1.position.x=bb1x;backing1.position.y=4.4;backing1.position.z=-RD/2+1.55;scene.add(backing1);
  const bill1=new THREE.Mesh(new THREE.PlaneGeometry(9.6,4.5),new THREE.MeshBasicMaterial({map:makeBillTex()}));
  bill1.position.x=bb1x;bill1.position.y=4.4;bill1.position.z=-RD/2+1.65;scene.add(bill1);
  const spot1=new THREE.SpotLight(0xffffff,2,20,Math.PI/5,.4);
  spot1.position.set(bb1x,8.5,-RD/2+7);spot1.target.position.set(bb1x,4.4,-RD/2+1.6);scene.add(spot1);scene.add(spot1.target);
  // Glow strip
  const bgs1=new THREE.Mesh(new THREE.BoxGeometry(9.8,.08,.08),new THREE.MeshBasicMaterial({color:0x00e5ff,transparent:true,opacity:.6}));
  bgs1.position.x=bb1x;bgs1.position.y=6.7;bgs1.position.z=-RD/2+1.66;scene.add(bgs1);

  // ── BILLBOARD 2: Patient Silhouette (back wall center-right) ──
  const bb2x=13;
  [-4.8,4.8].forEach(dx=>{
    const post=new THREE.Mesh(new THREE.BoxGeometry(.2,5.5,.2),postM);
    post.position.x=bb2x+dx;post.position.y=3.75;post.position.z=-RD/2+1.6;scene.add(post);
  });
  const cb2=new THREE.Mesh(new THREE.BoxGeometry(10.5,.2,.2),postM);cb2.position.x=bb2x;cb2.position.y=6.6;cb2.position.z=-RD/2+1.6;scene.add(cb2);
  const backing2=new THREE.Mesh(new THREE.BoxGeometry(9.8,4.6,.1),new THREE.MeshStandardMaterial({color:0x030c18,roughness:.9}));
  backing2.position.x=bb2x;backing2.position.y=4.4;backing2.position.z=-RD/2+1.55;scene.add(backing2);
  const bill2=new THREE.Mesh(new THREE.PlaneGeometry(9.6,4.5),new THREE.MeshBasicMaterial({map:makePatientTex()}));
  bill2.position.x=bb2x;bill2.position.y=4.4;bill2.position.z=-RD/2+1.65;scene.add(bill2);
  const spot2=new THREE.SpotLight(0xffffff,2,20,Math.PI/5,.4);
  spot2.position.set(bb2x,8.5,-RD/2+7);spot2.target.position.set(bb2x,4.4,-RD/2+1.6);scene.add(spot2);scene.add(spot2.target);
  const bgs2=new THREE.Mesh(new THREE.BoxGeometry(9.8,.08,.08),new THREE.MeshBasicMaterial({color:0xff8844,transparent:true,opacity:.6}));
  bgs2.position.x=bb2x;bgs2.position.y=6.7;bgs2.position.z=-RD/2+1.66;scene.add(bgs2);

  // ── PLAYER ──
  const player=new THREE.Group();scene.add(player);
  const body=new THREE.Mesh(new THREE.BoxGeometry(.7,1.4,.4),new THREE.MeshStandardMaterial({color:0xeef4ff,roughness:.9}));body.position.y=2.1;body.castShadow=true;player.add(body);
  const headM=new THREE.Mesh(new THREE.BoxGeometry(.55,.6,.55),new THREE.MeshStandardMaterial({color:0xffccaa,roughness:.9}));headM.position.y=3.2;headM.castShadow=true;player.add(headM);
  const lLeg=new THREE.Mesh(new THREE.BoxGeometry(.28,1,.28),new THREE.MeshStandardMaterial({color:0x334455,roughness:.9}));lLeg.position.set(-.2,1,0);lLeg.castShadow=true;player.add(lLeg);
  const rLeg=new THREE.Mesh(new THREE.BoxGeometry(.28,1,.28),new THREE.MeshStandardMaterial({color:0x334455,roughness:.9}));rLeg.position.set(.2,1,0);rLeg.castShadow=true;player.add(rLeg);
  player.position.set(0,0,6);

  // Controls
  const keys={};
  document.addEventListener("keydown",e=>{keys[e.code]=true;if(e.code==="Digit5"){fp=!fp;modeIndicator.textContent=fp?"FIRST PERSON":"THIRD PERSON";}});
  document.addEventListener("keyup",e=>keys[e.code]=false);
  let fp=true,wt=0,tgt=null;
  const half=RW/2-1,spd=.15;

  // Click marker
  const cm=new THREE.Mesh(new THREE.RingGeometry(.2,.3,32),new THREE.MeshBasicMaterial({color:0x00ff88,side:THREE.DoubleSide}));
  cm.rotation.x=-Math.PI/2;cm.position.y=.05;cm.visible=false;scene.add(cm);
  const pmMat=new THREE.MeshBasicMaterial({color:0x00ff88,transparent:true,opacity:.5,side:THREE.DoubleSide});
  const pr=new THREE.Mesh(new THREE.RingGeometry(.25,.32,32),pmMat);pr.rotation.x=-Math.PI/2;pr.position.y=.06;pr.visible=false;scene.add(pr);

  // Drug panel + patient panel
  const dp=document.getElementById("drugPanel");
  const pp=document.getElementById("patientPanel");
  const adminBtn=document.getElementById("adminBtn");
  document.getElementById("closeDrug").onclick=()=>{dp.style.display="none";currentDrug=null;};
  document.getElementById("closePatient").onclick=()=>{pp.style.display="none";};
  document.getElementById("checkRegimenBtn").onclick=checkRegimen;

  adminBtn.onclick=()=>{
    if(currentDrug){
      addToRegimen(currentDrug);
      adminBtn.textContent="ADMINISTERED ✓";
      adminBtn.classList.add("administered");
    }
  };

  function showPatientChart(){
    document.getElementById("ppPresenting").textContent=PATIENT.presenting;
    document.getElementById("ppVitals").textContent=PATIENT.vitals;
    document.getElementById("ppLabs").innerHTML=
      `<span class="lab-val crit">HbA1c: ${PATIENT.hba1c} ↑↑</span>`+
      `<span class="lab-val crit">FBG: ${PATIENT.fbg} ↑↑</span>`+
      `<span class="lab-val low">C-peptide: ${PATIENT.cpeptide} ↓↓</span>`;
    document.getElementById("ppAb").innerHTML=
      `<span class="lab-val pos">GAD65+</span>`+
      `<span class="lab-val pos">IA-2+</span>`+
      `<span class="lab-val pos">ZnT8+</span>`;
    document.getElementById("ppDx").textContent=PATIENT.dx;
    document.getElementById("ppPlan").textContent=PATIENT.plan;
    pp.style.display="block";
    dp.style.display="none";currentDrug=null;
  }

  // Make billboard 2 (patient board) clickable
  bill2.userData.isPatientBoard=true;
  backing2.userData.isPatientBoard=true;
  const clickableBoards=[bill2,backing2];

  function showDrug(drug){
    currentDrug=drug;
    document.getElementById("dptitle").textContent=drug.name;
    document.getElementById("dpclass").textContent=drug.cls;
    document.getElementById("dpind").textContent=drug.ind;
    document.getElementById("dpdose").textContent=drug.dose;
    document.getElementById("dpse").innerHTML=drug.se.map(([t,w])=>`<span class="dtag ${w}">${t}</span>`).join('');
    document.getElementById("dpmon").textContent=drug.mon;
    document.getElementById("dpmech").textContent=drug.mech;
    // Reset admin button state
    const alreadyAdded=patientRegimen.find(d=>d.name===drug.name);
    if(alreadyAdded){
      adminBtn.textContent="ADMINISTERED ✓";
      adminBtn.classList.add("administered");
    }else{
      adminBtn.textContent="ADMINISTER TO PATIENT";
      adminBtn.classList.remove("administered");
    }
    dp.style.display="block";
  }

  const ray=new THREE.Raycaster();const mo=new THREE.Vector2();
  let hoveredLabel=null;

  window.addEventListener("mousedown",e=>{
    if(e.target!==labCanvas)return;
    mo.x=(e.clientX/innerWidth)*2-1;
    mo.y=-(e.clientY/innerHeight)*2+1;
    ray.setFromCamera(mo,camera);

    // Check label clicks first
    const lhits=ray.intersectObjects(labelMeshes);
    if(lhits.length>0){pp.style.display="none";showDrug(lhits[0].object.userData.drug);return;}

    // Check patient board click
    const bhits=ray.intersectObjects(clickableBoards);
    if(bhits.length>0){showPatientChart();return;}

    dp.style.display="none";currentDrug=null;
    pp.style.display="none";
    const fhits=ray.intersectObject(floor);
    if(fhits.length>0){
      const pt=fhits[0].point;
      const cx=Math.max(-half,Math.min(half,pt.x));
      const cz=Math.max(-half,Math.min(half,pt.z));
      tgt=new THREE.Vector3(cx,player.position.y,cz);
      cm.position.x=cx;cm.position.z=cz;cm.visible=true;
      pr.position.x=cx;pr.position.z=cz;pr.visible=true;
    }
  });

  window.addEventListener("mousemove",e=>{
    if(e.target!==labCanvas)return;
    mo.x=(e.clientX/innerWidth)*2-1;mo.y=-(e.clientY/innerHeight)*2+1;
    ray.setFromCamera(mo,camera);
    const h=ray.intersectObjects(labelMeshes);
    const bh=ray.intersectObjects(clickableBoards);
    if(h.length>0){labCanvas.style.cursor="pointer";hoveredLabel=h[0].object;}
    else if(bh.length>0){labCanvas.style.cursor="pointer";hoveredLabel=null;}
    else{labCanvas.style.cursor="default";hoveredLabel=null;}
  });

  const tpOff=new THREE.Vector3(0,28,18);let tpPos=new THREE.Vector3().copy(player.position).add(tpOff);

  function loop(){
    requestAnimationFrame(loop);
    let walk=false;
    if(tgt){
      const d=player.position.distanceTo(tgt);
      if(d>.12){
        const dir=new THREE.Vector3().subVectors(tgt,player.position).normalize();
        player.position.addScaledVector(dir,spd);
        let da=Math.atan2(dir.x,dir.z)-player.rotation.y;
        while(da>Math.PI)da-=Math.PI*2;while(da<-Math.PI)da+=Math.PI*2;
        player.rotation.y+=da*.15;walk=true;
      }else{tgt=null;cm.visible=false;pr.visible=false;}
    }
    if(keys["KeyQ"])player.rotation.y+=.04;
    if(keys["KeyE"])player.rotation.y-=.04;
    player.position.x=Math.max(-half,Math.min(half,player.position.x));
    player.position.z=Math.max(-half,Math.min(half,player.position.z));
    if(walk){wt+=.25;lLeg.rotation.x=Math.sin(wt)*.7;rLeg.rotation.x=-Math.sin(wt)*.7;body.position.y=2.1+Math.abs(Math.sin(wt*2))*.02;}
    else{lLeg.rotation.x=0;rLeg.rotation.x=0;body.position.y=2.1;}
    if(pr.visible){const t=Date.now()*.003;pmMat.opacity=.3+Math.sin(t*4)*.25;const s=1+Math.sin(t*4)*.15;pr.scale.set(s,1,s);}

    labelMeshes.forEach(m=>m.lookAt(camera.position));
    const t2=Date.now()*.001;
    labelMeshes.forEach(m=>{
      const isHov=m===hoveredLabel;
      m.material.opacity=isHov?1:.92+Math.sin(t2*1.5+m.position.x)*.08;
    });

    if(fp){
      const eye=new THREE.Vector3(0,3.35,0).applyQuaternion(player.quaternion).add(player.position);
      camera.position.copy(eye);
      camera.lookAt(eye.clone().add(new THREE.Vector3(0,0,1).applyQuaternion(player.quaternion)));
    }else{
      tpPos.lerp(player.position.clone().add(tpOff),.08);
      camera.position.copy(tpPos);camera.lookAt(player.position);
    }
    const t3=Date.now()*.001;
    scene.children.forEach(c=>{if(c.isPointLight&&c.color.b>.8)c.intensity=.8+Math.sin(t3*60+c.position.x)*.01;});
    renderer.render(scene,camera);
  }
  loop();

  window.addEventListener("resize",()=>{camera.aspect=innerWidth/innerHeight;camera.updateProjectionMatrix();renderer.setSize(innerWidth,innerHeight);});
}
window.addEventListener("resize",()=>{eCam.aspect=innerWidth/innerHeight;eCam.updateProjectionMatrix();eRend.setSize(innerWidth,innerHeight);});
</script>
</body>
</html>